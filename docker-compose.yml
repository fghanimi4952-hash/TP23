# Docker Compose pour déployer l'ensemble des microservices avec Consul
# ======================================================================

version: '3.8'

services:
  # Service Consul : Découverte de services
  # ----------------------------------------
  consul:
    image: consul:1.16
    container_name: consul
    ports:
      # Port HTTP pour l'interface web Consul
      - "8500:8500"
      # Ports pour la communication entre agents Consul (non nécessaires en mode dev)
      - "8600:8600/udp"
    command: consul agent -dev -client=0.0.0.0
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Base de données MySQL pour le service Client
  # ---------------------------------------------
  mysql-client:
    image: mysql:8.0
    container_name: mysql-client
    environment:
      # Variables d'environnement MySQL
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: Micro_ClientDB
    ports:
      # Port 3309 pour éviter les conflits avec d'autres instances MySQL
      - "3309:3306"
    volumes:
      # Persistance des données
      - mysql-client-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de données MySQL pour le service Voiture
  # ----------------------------------------------
  mysql-voiture:
    image: mysql:8.0
    container_name: mysql-voiture
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: Micro_VoitureDB
    ports:
      # Port 3308 pour le service Voiture
      - "3308:3306"
    volumes:
      - mysql-voiture-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Service Client (Microservice Client)
  # ------------------------------------
  service-client:
    build:
      context: ./service-client
      dockerfile: Dockerfile
    container_name: service-client
    ports:
      - "8081:8081"
    environment:
      # Configuration Consul : pointer vers le service Consul dans Docker
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      # Configuration MySQL : pointer vers le service MySQL dans Docker
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-client:3306/Micro_ClientDB?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - consul
      - mysql-client
    networks:
      - microservices-network
    restart: unless-stopped

  # Service Voiture (Microservice Voiture)
  # --------------------------------------
  service-voiture:
    build:
      context: ./service-voiture
      dockerfile: Dockerfile
    container_name: service-voiture
    ports:
      - "8082:8082"
    environment:
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-voiture:3306/Micro_VoitureDB?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      - consul
      - mysql-voiture
    networks:
      - microservices-network
    restart: unless-stopped

  # Service Gateway (API Gateway)
  # -----------------------------
  service-gateway:
    build:
      context: ./service-gateway
      dockerfile: Dockerfile
    container_name: service-gateway
    ports:
      - "8888:8888"
    environment:
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
    depends_on:
      - consul
      - service-client
      - service-voiture
    networks:
      - microservices-network
    restart: unless-stopped

# Réseau Docker pour la communication entre les services
# -------------------------------------------------------
networks:
  microservices-network:
    driver: bridge

# Volumes pour la persistance des données
# ----------------------------------------
volumes:
  mysql-client-data:
  mysql-voiture-data:
